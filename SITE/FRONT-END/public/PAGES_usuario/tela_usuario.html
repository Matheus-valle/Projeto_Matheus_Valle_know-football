<!DOCTYPE html>
<html lang="en">

<head>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../css/tela_usuario.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lilita+One&display=swap" rel="stylesheet">
    <link rel="icon" href="../assets/bola_icon.png" type="image/x-icon">
    <title>tela home</title>
</head>

<body onload="
   obterDadosGraficoMetricasCadastradas();
    mostrar_posição_usuario();
    ">
    <header>
        <div class="logo">
            <img onclick="home()" src="../assets/LOGO-removebg-preview.png" alt="img">
        </div>
        <div class="mensagem_usuario" id="mensagem_usuario">

        </div>
    </header>

    <div class="pagina_total">
        <div class="nav_bar">
            <p>PAGINAS</p>

            <button><a href="tela_usuario.html">HOME</a></button>
            <button><a href="tela_times.html">SELETIVAS</a></button>

        </div>

        <div class="lista">
            <div class="posição">
                <div class="textos">
                    <p>SEUS DADOS ESTÃO SENDO </p>
                    <p> COMPUTADOS PARA A POSIÇÃO:</p>
                    <p id="p_posicao" style="color: yellow;"></p>
                </div>
                <div id="img_usuario">


                </div>

            </div>
            <div class="dashboard">
                <div class="titulo">
                    <h1 style="color: white;">SEU ACOMPANHAMENTO PARA UMA SELETIVA DE FUTEBOL AMERICANO:</h1>
                </div>
                <div class="card_dashboard">
                    <div class="titulo_dashboard">
                        <h1 style="font-size: 20px;">Corrida de 40 jardas (36)Metros</h1>
                    </div>
                    <div class="mensagens_usuario">
                    <div class="calculo">
                        <p style="font-size: 10px;">CALCULO UTILIZADO PARA AS METRICAS: <span style="color: black">PROJEÇÃO NOVO MÊS = MES_ANTERIOR -  (FREQUENCIA * TEMPO_MES ATUAL / 100)</span> </p>
                    </div>
                    <br>
                    <div class="posição_calculo">
                        <p style="font-size: 13px;">PARA SUA POSIÇÃO <span style="color: rgb(0, 0, 0);"   id="posição_card"></span> O IDEAL PARA UM INICIANTE É <span style="color: rgb(0, 0, 0);" id="tiro_40y_card"></span></p>
                    </div>
                    </div>


                    <div class="KPIS">
                        <div class="KPI_1" id="KPI_1">
                            <p style="font-size: 10px;">TAXA DE REDUÇÃO DE TEMPO MENSAL</p>
                            <div class="KP1_TEMPO" style=" background-color:  rgb(255, 255, 255); color: black;">
                                <p>NDA</p>
                            </div>
                        </div>
                        <div class="KPI_2" id="KPI_2">
                            <p style="font-size: 10px;">EVOULUÇÃO PARA O FUTEBOL AMERICANO</p>
                            <div id="kpi_2"   class="KP2_FUTEBOL" style=" background-color:  rgb(255, 255, 255); color: black;">
                                <p id="texto_kp2">NDA</p>
                            </div>
                        </div>
                        <div class="KPI_3" id="KPI_3">
                            <p style="font-size: 10px;">GANHO DE TEMPO TOTAL</p>
                            <div class="KP3_GANHO"   style=" background-color:  rgb(255, 255, 255); color: black;">
                                <p>NDA </p>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <canvas id="myChart"></canvas>
                    </div>

                    <div class="registros">
                        <div class="inputs">
                            <div class="input1">
                                <p>SELECIONE O MÊS:</p>
                                <select id="Input_mes">
                                    <option value=1>1</option>
                                    <option value=2>2</option>
                                    <option value=3>3</option>
                                    <option value=4>4</option>
                                    <option value=5>5</option>
                                    <option value=6>6</option>
                                </select>
                            </div>
                            <div class="input2">
                                <p>DIGITE O TEMPO:</p>
                                <input type="number" id="input_tempo">
                            </div>
                        </div>
                        <div class="botões_registro">
                            <div class="botão01">
                                <p>CADASTRAR:</p>
                                <button onclick="cadastrar_metrica_tiro40y()">CADASTRO</button>
                            </div>
                            <div class="input2">
                                <p>EDITAR:</p>
                                <button onclick="editar_metrica_tiro40y()">EDITAR</button>
                            </div>
                            <div id="div_erro"></div>
                        </div>
                    </div>
                </div>
                                

              
    </div>

    
</body>

</html>

<script>
    
    

    mensagem_usuario.innerHTML = `<h1>OLÁ ${sessionStorage.NOME_USUARIO}</h1>`

    function home() {
        window.location = "../index.html"
    }



    function cadastrar_metrica_tiro40y() {
        console.log("botao apertado")

          var idUsuario = sessionStorage.ID_USUARIO
       var mes =  Number(Input_mes.value)
       var tempo = Number(input_tempo.value)

       if(mes < 1 || tempo < 1  || (mes  >= 7)) {
        div_erro.innerHTML = `<b style="color: red">Mês invalido ou coloque todos os dados para cadastro!</b>`
       } else {

       
        fetch(`/medidas/cadastrar_metrica/`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        // crie um atributo que recebe o valor recuperado aqui
        // Agora vá para o arquivo routes/usuario.js
        serverMes: mes,
        serverTemmpo: tempo,
        serveridUsuario: idUsuario

      }),
    })
      .then(function (resposta) {
        console.log("resposta: ", resposta);
            

        if (resposta.ok) {
    
           div_erro.innerHTML = `<b style="color: green;">Tempo cadastrado com sucesso</b>` 


                   if (myChart) {
            console.log("o chart js está no antigo")
            myChart.destroy()
        }

           obterDadosGraficoMetricasCadastradas(idUsuario)
        } else {
          throw "Houve um erro ao tentar realizar o cadastro!";
        }
      })
      .catch(function (resposta) {
        console.log(`#ERRO: ${resposta}`);
       div_erro.innerHTML = `<b style="color: red;">Tempo já cadastrado</b>` 
      });

    return false;
    }   
}

function editar_metrica_tiro40y() {
    
          var idUsuario = sessionStorage.ID_USUARIO
       var mes =  Number(Input_mes.value)
       var tempo = Number(input_tempo.value)

       if(mes < 1 || tempo < 1  && (mes  > 6)) {
        div_erro.innerHTML = `<b style="color: red">Mês errado ou coloque todos os dados para editar!</b>`
       } else {

       
        fetch(`/medidas/editar_metrica/`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        // crie um atributo que recebe o valor recuperado aqui
        // Agora vá para o arquivo routes/usuario.js
        serverMes: mes,
        serverTemmpo: tempo,
        serveridUsuario: idUsuario

      }),
    })
      .then(function (resposta) {
        console.log("resposta: ", resposta);
            

        if (resposta.ok) {
    
           div_erro.innerHTML = `<b style="color: green;">Tempo editado com sucesso!</b>` 
            if (myChart) {
            console.log("o chart js está no antigo")
            myChart.destroy()
        }


           obterDadosGraficoMetricasCadastradas(idUsuario)
          
          
        } else {
          throw "Houve um erro ao tentar realizar o cadastro!";
        }
      })
      .catch(function (resposta) {
        console.log(`#ERRO: ${resposta}`);
       div_erro.innerHTML = `<b style="color: red;">Tempo não cadastrado ainda!</b>` 
      });

    return false;
    }
}

var  tempo_minimo_40y =  type(int)
        
        var minimo_cone3 = 0

        var minimo_supino = 0

    function mostrar_posição_usuario() {

               var idUsuario = sessionStorage.ID_USUARIO





        fetch(`/medidas/buscarAltura/${idUsuario}`, {
                cache: 'no-store'
            }).then(function(response) {
                if (response.ok) {
                    response.json().then(function(resposta) {
                        resposta.reverse();

                        console.log(resposta)
                        
                       var peso = resposta[0].peso_usuario
                       var altura = parseFloat(resposta[0].altura_usuario)
                       var img = ""
                       var posição = ""


                        if (peso > 0 && altura > 0) {
            posição = `Running Back`
            img = `<img src="../assets/runningback_icon.jpg">`
            tempo_minimo_40y = 4.32 + (4.32 * 0.30 )


            if (peso > 75 && altura > 1.75) {
                posição = `Corner Back`
                img = `<img src="../assets/cornerback_icon.jpg">`
                tempo_minimo_40y = 4.59+ (4.59 * 0.30 )


                if (peso > 80 && altura > 1.80) {
                    posição = `Wide Receiver`
                    img = `<img src="../assets/widereceiver_icon.jpg">`
                tempo_minimo_40y = 4.50+ (4.50 * 0.30 )

                   
                    if (peso > 100 && altura > 1.82) {
                        posição = `Linebacker`
                        img = `<img src="../assets/linebacker_icon.jpeg">`
                tempo_minimo_40y = 4.60+ (4.60 * 0.30 )

                        if (peso > 104 && altura > 1.83) {
                            posição = `Quarter back`
                            img = `<img src="../assets/quarterback_icon.jpeg">`
                tempo_minimo_40y = 4.60+ (4.60 * 0.30 )

                            if (peso > 106 && altura > 1.85) {
                                posição = `Tight end`
                                img = `<img src="../assets/tightend_icon.jpg">`
                                                tempo_minimo_40y = 4.70+ (4.70 * 0.30 )

                                if (peso > 115 && altura > 1.87) {
                                    posição = `Defensive Lineman`
                                    img = `<img src="../assets/defensivelineman_icon.jpeg">`
                                                    tempo_minimo_40y = 4.83+ (4.83 * 0.30 )

                                    if (peso > 125 && altura > 1.90) {
                                        posição = `Offensive Lineman`
                                        img = `<img src="../assets/ofensivelineman_icon.jpeg">`
                                                        tempo_minimo_40y = 4.91+ (4.91 * 0.30 )


                                    }
                                }
                            }
                        }
                    }
                }
            }
        }

                img_usuario.innerHTML += img
        p_posicao.innerHTML = posição
        posição_card.innerHTML = posição
        tiro_40y_card.innerHTML = tempo_minimo_40y.toFixed(2) 
                    });
                } else {
                    console.error('Nenhum dado encontrado ou erro na API');
                }
            })
            .catch(function(error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
            
            
        



 


       





    } 



    function obterDadosGraficoMetricasCadastradas() {
        var resposta_metricas
        var idUsuario = sessionStorage.ID_USUARIO
        var resposta_acompanhamento1 
        var resposta_acompanhamento2
        var resposta_acompanhamento3 
        var resposta_acompanhamento4
        var resposta_acompanhamento5 
        var resposta_acompanhamento6
          



        fetch(`/medidas/MetricasCadastradas/${idUsuario}`, {
                cache: 'no-store'
            }).then(function(response) {
                if (response.ok) {
                    response.json().then(function(resposta) {
                        resposta.reverse();

                        resposta_metricas = resposta[0]
                         if (( resposta_acompanhamento1 != undefined  || resposta_acompanhamento2 != undefined ||
                                resposta_acompanhamento3 != undefined || resposta_acompanhamento4 != undefined ||
                                resposta_acompanhamento5 != undefined || resposta_acompanhamento6 != undefined
                            ) && resposta_metricas != undefined) {
                                plotar_grafico(resposta_acompanhamento1, resposta_acompanhamento2, resposta_acompanhamento3,
                                resposta_acompanhamento4, resposta_acompanhamento5,resposta_acompanhamento6 , resposta_metricas)
                            }

                    });
                } else {
                    console.error('Nenhum dado encontrado ou erro na API');
                }
            })
            .catch(function(error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });

      

        fetch(`/medidas/ultimas/${idUsuario}`, {
                cache: 'no-store'
            }).then(function(response) {
                if (response.ok) {
                    response.json().then(function(resposta) {
                        resposta.reverse();



                        for(i = 0; i <6; i ++ ){
                            if(resposta[i] == undefined) {
                                resposta[i] = resposta[i] = {mes: null, metrica_tiro40y: null};  
                            }
                            
                        }


                        var ordenamento_mes = [[], [], [], [], [], []]

                    
                            for(i = 0; i< 6; i++) {
                                var momento_lista = resposta[i]
                                if(resposta[i].mes != null) {

                                    if(resposta[i].mes == 1) {
                                        ordenamento_mes[0].push(resposta[i])
                                    }


                                    if(resposta[i].mes == 2) {
                                        ordenamento_mes[1].push(resposta[i])
                                    }


                                    if(resposta[i].mes == 3) {
                                        ordenamento_mes[2].push(resposta[i])
                                    }


                                    if(resposta[i].mes == 4) {
                                        ordenamento_mes[3].push(resposta[i])
                                    }

                                    if(resposta[i].mes == 5) {
                                        ordenamento_mes[4].push(resposta[i])
                                    }


                                    if(resposta[i].mes == 6) {
                                        ordenamento_mes[5].push(resposta[i])
                                    }
                                }

                            } 

                            if(ordenamento_mes[0].length == 0) {
                                ordenamento_mes[0].push({mes: null, metrica_tiro40y: null})
                                resposta_acompanhamento1 = ordenamento_mes[0][0]
                            } else {
                                resposta_acompanhamento1 =  ordenamento_mes[0][0]
                            }

                            if(ordenamento_mes[1].length == 0) {
                                ordenamento_mes[1].push({mes: null, metrica_tiro40y: null})
                                resposta_acompanhamento2 = ordenamento_mes[1][0]
                            } else {
                                resposta_acompanhamento2 =  ordenamento_mes[1][0]
                            }

                            if(ordenamento_mes[2].length == 0) {
                                ordenamento_mes[2].push({mes: null, metrica_tiro40y: null})
                                resposta_acompanhamento3 = ordenamento_mes[2][0]
                            } else {
                                resposta_acompanhamento3 =  ordenamento_mes[2][0]
                            }

                        
                            if(ordenamento_mes[3].length == 0) {
                                ordenamento_mes[3].push({mes: null, metrica_tiro40y: null})
                                resposta_acompanhamento4 = ordenamento_mes[3][0]
                            } else {
                                resposta_acompanhamento4 =  ordenamento_mes[3][0]
                            }


                            if(ordenamento_mes[4].length == 0) {
                                ordenamento_mes[4].push({mes: null, metrica_tiro40y: null})
                                resposta_acompanhamento5 = ordenamento_mes[4][0]
                            } else {
                                resposta_acompanhamento5 =  ordenamento_mes[4][0]
                            }


                            if(ordenamento_mes[5].length == 0) {
                                ordenamento_mes[5].push({mes: null, metrica_tiro40y: null})
                                resposta_acompanhamento6 = ordenamento_mes[5][0]
                            } else {
                                resposta_acompanhamento6 =  ordenamento_mes[5][0]
                            }      
                        

        

                            if (( resposta_acompanhamento1 != undefined  || resposta_acompanhamento2 != undefined ||
                                resposta_acompanhamento3 != undefined || resposta_acompanhamento4 != undefined ||
                                resposta_acompanhamento5 != undefined || resposta_acompanhamento6 != undefined
                            ) && resposta_metricas != undefined) {
                                plotar_grafico(resposta_acompanhamento1, resposta_acompanhamento2, resposta_acompanhamento3,
                                resposta_acompanhamento4, resposta_acompanhamento5,resposta_acompanhamento6 , resposta_metricas)
                            }


                                       var ultimo_mes = 0
                                       var penultimo_mes

            if (resposta_acompanhamento6.mes != null) {
                ultimo_mes = resposta_acompanhamento6
                penultimo_mes = resposta_acompanhamento5
            } else if (resposta_acompanhamento5.mes != null) {
                ultimo_mes = resposta_acompanhamento5
                penultimo_mes = resposta_acompanhamento4
            } else if (resposta_acompanhamento4.mes != null) {
                ultimo_mes = resposta_acompanhamento4
                penultimo_mes = resposta_acompanhamento3
            } else if (resposta_acompanhamento3.mes != null)  {
                ultimo_mes = resposta_acompanhamento3
                penultimo_mes = resposta_acompanhamento2
            } else if (resposta_acompanhamento2.mes != null) {
                ultimo_mes = resposta_acompanhamento2
                penultimo_mes = resposta_acompanhamento1
            } else  {
                ultimo_mes = resposta_acompanhamento1
                penultimo_mes = resposta_acompanhamento1
            }

            if(ultimo_mes.metrica_tiro40y  < tempo_minimo_40y) { 

                KPI_2.innerHTML =  `                            <p style="font-size: 10px;">EVOULUÇÃO PARA O FUTEBOL AMERICANO</p>
                            <div id="kpi_2"   class="KP2_FUTEBOL" style="background-color:  green; color: white;">
                                <p id="texto_kp2">MUITO BOA</p>`                        
                            
            } else  if (ultimo_mes.metrica_tiro40y  < (tempo_minimo_40y + (tempo_minimo_40y * 0.30)) && ultimo_mes.metrica_tiro40y >= tempo_minimo_40y ) {
                                KPI_2.innerHTML =  `                            <p style="font-size: 10px;">EVOULUÇÃO PARA O FUTEBOL AMERICANO</p>
                            <div id="kpi_2"   class="KP2_FUTEBOL" style="background-color:  yellow; color: black;">
                                <p id="texto_kp2">MEDIANA</p>`    
            } else {
                                                KPI_2.innerHTML =  `                            <p style="font-size: 10px;">EVOULUÇÃO PARA O FUTEBOL AMERICANO</p>
                            <div id="kpi_2"   class="KP2_FUTEBOL" style="background-color:  red; color: white;">
                                <p id="texto_kp2">RUIM</p>`    
            }

            var calculo_evolução = parseFloat(penultimo_mes.metrica_tiro40y) -  parseFloat(ultimo_mes.metrica_tiro40y)
            
            console.log("esté é o calculo de evolução "  + calculo_evolução)
            if (calculo_evolução > 0.3) {
                KPI_1.innerHTML = `
                                            <p style="font-size: 10px;">TAXA DE REDUÇÃO DE TEMPO MENSAL</p>
                            <div class="KP1_TEMPO" style=" background-color:  green; color: white;">
                                <p>${calculo_evolução.toFixed(1)}</p>
                            </div>
                ` 
            }
            else if (calculo_evolução > 0.1) {
                KPI_1.innerHTML = `
                                            <p style="font-size: 10px;">TAXA DE REDUÇÃO DE TEMPO MENSAL</p>
                            <div class="KP1_TEMPO" style=" background-color:  yellow; color: white;">
                                <p>${calculo_evolução.toFixed(1)}</p>
                            </div>
                ` 
            } else {
                                KPI_1.innerHTML = `
                                            <p style="font-size: 10px;">TAXA DE REDUÇÃO DE TEMPO MENSAL</p>
                            <div class="KP1_TEMPO" style=" background-color:  red; color: white;">
                                <p>${calculo_evolução.toFixed(1)}!</p> `
                   
            }

    

          console.log( typeof(  ultimo_mes.metrica_tiro40y))
          var ultimo_mes_metrica_40y = parseFloat(ultimo_mes.metrica_tiro40y)
            var evolução_total =    resposta_metricas.metrica_tiro40y  - ultimo_mes_metrica_40y  
            console.log("está é a evolução total: " + evolução_total)

             if (evolução_total < 0.3) {
                                KPI_3.innerHTML = `
                                            <p style="font-size: 10px;">TAXA DE REDUÇÃO DE TEMPO MENSAL</p>
                            <div class="KP3_GANHO" style=" background-color:  red; color: white;">
                                <p>${evolução_total.toFixed(1)}!</p> `
            }
            else if (evolução_total <  0.6) {
                KPI_3.innerHTML = `
                                            <p style="font-size: 10px;">TAXA DE REDUÇÃO DE TEMPO MENSAL</p>
                            <div class="KP3_GANHO" style=" background-color:  yellow; color: white;">
                                <p>${evolução_total.toFixed(1)}</p> `
                
            } else {
                                KPI_3.innerHTML = `
                                                                            <p style="font-size: 10px;">TAXA DE REDUÇÃO DE TEMPO MENSAL</p>
                            <div class="KP3_GANHO" style=" background-color:  green; color: white; width ">
                                <p>${evolução_total.toFixed(1)}</p> ` 
           
                   
            }

           
                        
                    });
                } else {
                    console.error('Nenhum dado encontrado ou erro na API');
                }
            })
            .catch(function(error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });



            

    }



    function plotar_grafico(resposta_acompanhamento1, resposta_acompanhamento2, resposta_acompanhamento3,
                                resposta_acompanhamento4, resposta_acompanhamento5,resposta_acompanhamento6 , resposta_metricas) {



                            

        var idUsuario = sessionStorage.ID_USUARIO
                                             
        var metrica_cadastrado1 = parseFloat( resposta_acompanhamento1.metrica_tiro40y)
        var metrica_cadastrado2 = parseFloat(resposta_acompanhamento2.metrica_tiro40y)
        var metrica_cadastrado3 = parseFloat(resposta_acompanhamento3.metrica_tiro40y)
       var metrica_cadastrado4 = parseFloat(resposta_acompanhamento4.metrica_tiro40y)
        var metrica_cadastrado5 = parseFloat(resposta_acompanhamento5.metrica_tiro40y)
        var metrica_cadastrado6 = parseFloat(resposta_acompanhamento6.metrica_tiro40y)  

    
        

        var frequencia = resposta_metricas.frequencia_treino
        var mes0 =  resposta_metricas.metrica_tiro40y
        var mes1 = mes0 - (frequencia * resposta_metricas.metrica_tiro40y / 100)
        var mes2 = mes1 - (frequencia * mes1 / 100)
        var mes3 = mes2 - (frequencia * mes2 / 100)
        var mes4 = mes3 - (frequencia * mes3 / 100)
        var mes5 = mes4 - (frequencia * mes4 / 100)
        var mes7 = mes5 - (frequencia * mes5 / 100)
       

        let labels = [];

       
    
        let dados = {
            labels: labels,
            labels: ['Tempo', 'Mês 1', 'Mês 2', 'Mês 3', 'Mês 4', 'Mês 5', 'Mês 6'],
        
            datasets: [{
                    label: 'Sua Projeção',
                    data: [mes0, mes1, mes2, mes3, mes4, mes5, mes7]
                },
                {
                    label: 'Em andamento', 
                    data: [mes0, metrica_cadastrado1, metrica_cadastrado2, metrica_cadastrado3, metrica_cadastrado4, metrica_cadastrado5, metrica_cadastrado6]  

                },
                                {
                    label: 'Recomendado Posição', 
                    data: [tempo_minimo_40y, tempo_minimo_40y, tempo_minimo_40y, tempo_minimo_40y, tempo_minimo_40y, tempo_minimo_40y, tempo_minimo_40y]  

                }
            ]
        };



    
        const config = {
            type: 'line',
            data: dados,
        };

      




        myChart = new Chart(
            document.getElementById(`myChart`),
            config
        );

     
    }

   
</script>